# Building the TMS570 CMake Template

This is a guide to adapting the original repository to its current state for which it can compile TMS570LC4357 programs using the CLion IDE. This is a useful guide for people in the future who wish to port this to their own arbitrary TI microcontroller and use it with CLion.

This assumes that you want to compile with the [TI ARM-CGT compiler](https://www.ti.com/tool/ARM-CGT).

## Caveats

Note that CLion does not have first class support for embedded development with TI microcontrollers, only STM32s. This means that while typical powerful features like code completion, checking, static analysis and all that IDE magic works, flashing to board or running the debugger with CLion would be otherwise impossible. Those tasks must be run using TI's own Code Composer Studio.  

## Step 1: Create the Custom Compiler file

CLion and some other IDEs require a custom compiler file such that it overrides existing compiler checks. CLion assumes either `clang` or `gcc` compilers and uses common flags for them, which is incompatible with the TI ARM-CGT compiler. 

The original YAML file that I built this from can be located from CLion's own documentation [here](https://github.com/JetBrains/clion-custom-defined-compiler-examples/blob/master/CMake-Texas-Instruments-MSP430-CGT/custom-compiler-msp430.yaml).

The field for `defines-text` can be obtained by running the compiler with the flag `--preproc-macros` to obtain all the compiler's custom preprocessor defines:

```bash
# Create empty C source file
touch main.c

# Extract the full command by compiling a CCS project and copying the compile command over and appending --preproc_macros main.c
"/Applications/ti/ccs1281/ccs/tools/compiler/ti-cgt-arm_20.2.7.LTS/bin/armcl" -mv7R5 --code_state=32 --float_support=VFPv3D16 --include_path="/Users/user/Developer/Hardware/workspace_v12/hercules_examples/Launchpad/570LS/570LC43/Project_0" --include_path="/Users/user/Developer/Hardware/workspace_v12/hercules_examples/Launchpad/570LS/570LC43/Project_0/include" --include_path="/Applications/ti/ccs1281/ccs/tools/compiler/ti-cgt-arm_20.2.7.LTS/include" -g --diag_warning=225 --diag_wrap=off --display_error_number --enum_type=packed --abi=eabi --preproc_with_compile --preproc_macros main.c

# Main.pp is the file that will contain all the defines which you can copy into the defines-text field
cat main.pp 
```

Next, change the `code-insight-target-name` field to `arm-ti-none-eabi`, which reflects the correct `clangd`.

Finally, change the `match-compiler-exe` field to use `armcl` as the compiler

## Step 2: Replace all BSP files with TMS570 specific files

Within the `project/BSP/HALCoGen/TiBSPBareMetal`, replace the following files with your project's specific files that were generated by HALCoGen. 

- `TiBSPBaremetal.dil`, modify original project file name to this file name
- `TiBSPBaremetal.hcg`, modify original project file name to this file name
- All files in `source`
- All files in `include`

> NOTE: BSPFreeRTOS has not been modified by me yet and is not suitable for deployment at this time.

## Step 3: Modify CMake files to run the toolchain available on your computer

Modify the following files so that their parameters match that of your computer's setup:

- `project/cmake/ti_linux-toolchain.cmake`
    - If you are on Linux or macOS, change `TOOLCHAIN_PREFIX` to the location of the `armcl` toolchain. For macOS, the directory is `/Applications/ti/ccs1281/ccs/tools/compiler/ti-cgt-arm_20.2.7.LTS` if you installed CCS 12.8.1
- `project/cmake/ti_win-toolchain.cmake`
    - If you are on Windows, change `TOOLCHAIN_PREFIX` to the location of the `armcl` toolchain.
- `project/cmake/ti_toolchain.cmake`
    - Ensure that all compilation commands use flags/arguments supported by `armcl`, as common flags supported by typical compilers like `gcc` (e.g. `-Og`) does not work.

Add the flash map file located in `project/cmake` called `ti_tms570lc43_cfg.ld`. This is generated by HALCoGen as `sys_link.cmd` by default. 

## Done!

Now you're done! Try compiling your program in CLion.
